{% extends "doi_site/organisation_wrapper.html" %} {% block head %}
<link
  href="/static/doi_site/css/bootstrap.css"
  rel="stylesheet"
/>
<link
rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
/>
<link href='https://search.crossref.org/typeahead.css' media='screen' rel='stylesheet' type='text/css'>
<script src='//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js' type='text/javascript'></script>
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
  crossorigin="anonymous"
></script>
<script src='https://twitter.github.io/typeahead.js/releases/0.10.5/typeahead.bundle.js' type='text/javascript'></script>
<script src="https://twitter.github.io/hogan.js/builds/3.0.1/hogan-3.0.1.js" type='text/javascript'></script>
{% endblock %} {% block content %}
<div class="doi_bootstrap">
  <h2 class="offset-5 bold--text">DOI Form</h2>
  <div class="row">
    <div class="col-md-2"></div>
    <div class="col-md-8">
      <form class="form-horizontal" method="POST" action="">
        {% csrf_token %}
        <div class="pb-1 mt-3">
          <label for="identifier" class="form-label fs-6 required"
            >Identifier</label
          >
        </div>
        <div class="input-group input-group-sm pb-1">
          <span class="input-group-text" id="prefix">{{ doi_prefix }}/</span>
          {{ form.identifier }}
        </div>
        {% if notAuthorised %}
        <div
          class="alert alert-danger text-start d-flex align-items-center"
          role="alert"
          style="height: 15px"
        >
          You are only authorised to use the sub-domains listed below:
        </div>
        {% endif %}
        <span> DOI Sub-Domains available: </span>
        <ul>
          {% for suffix in suffixlist %}
          <li>{{ suffix }}</li>
          {% empty %}
          <li style="color: red">
            No DOI sub-domains available, please create one.
          </li>
          {% endfor %}
        </ul>

        <div class="row">
          <div class="col-1">
            <a href="#identifierHelpBlock" data-bs-toggle="collapse"
              ><i
                onclick="toggleArrow(this)"
                class="fa fa-caret-down fa-2x fa-fw"
              ></i
            >
            <span class="sr-only">Identifier helper text toggle</span></a>
          </div>
          <div class="col-11">
            <div id="identifierHelpBlock" class="collapse show pb-2 text-dark">
              Only add the name of the identifier as the DOI number (10.528) will
              be added automatically. The Identifier is a unique string that
              identifies a resource. For software, determine whether the
              identifier is for a specific version of a piece of software, (per
              the Force11 Software Citation Principles11), or for all versions. DOI
              (Digital Object Identifier) registered by a DataCite member. Format
              should be ‚Äú10.1234/foo‚Äù
            </div>
          </div>
        </div>

        <div class="pb-1">
          <label for="title" class="form-label fs-6 mt-3 required">Title</label>
        </div>
        <div class="pb-1">{{ form.title }}</div>
        <div class="row">
          <div class="col-1">
            <a href="#titleHelpBlock" data-bs-toggle="collapse"
              ><i
                onclick="toggleArrow(this)"
                class="fa fa-caret-down fa-2x fa-fw"
              ></i
            ><span class="sr-only">Title helper text toggle</span></a></a>
          </div>
          <div class="col-11">
            <div
              id="titleHelpBlock"
              class="collapse show form-text pb-2 text-dark"
            >
              A name or title by which a resource is known. May be the title of a
              dataset or the name of a piece of software.
            </div>
          </div>
        </div>

        {{ creatorformset.management_form }}
        <div class="pb-1">
          <label for="creator" class="form-label fs-6 mt-3 required"
            >Creator</label
          >
        </div>
        {% for form in creatorformset %}
        <div class="row form-row spacer creatorformset-row">
          <div class="row mb-2">
            <div class="col">{{form.givenname}}</div>
            <div class="col">{{form.familyname}}</div>
            <div class="col">{{form.orcid}}</div>
            <div class="col">{{form.affiliation}}</div>
            <div class="col-1">
              <button type="button" class="btn btn-danger remove-form-row btn-sm">
                üóô
              </button>
            </div>
          </div>
        </div>
        {% endfor %}
        <button
          type="button"
          id="creatorformset-add"
          class="btn btn-success btn-sm add-form-row"
        >
          Add creator
        </button>

        <div class="row">
          <div class="col-1">
            <a href="#creatorHelpBlock" data-bs-toggle="collapse"
              ><i
                onclick="toggleArrow(this)"
                class="fa fa-caret-down fa-2x fa-fw"
              ></i
            ><span class="sr-only">Funder helper text toggle</span></a></a>
          </div>
          <div class="col-11">
            <div
              id="creatorHelpBlock"
              class="collapse show form-text pb-2 text-dark"
            >
              The main researchers involved in producing the data, or the authors
              of the publication, in priority order.
            </div>
          </div>
        </div>

        <div class="pb-1">
          <label for="abstract" class="form-label fs-6 mt-3">Abstract</label>
        </div>
        <div class="pb-1">{{ form.abstract }}</div>
        <div class="row">
          <div class="col-1">
            <a href="#abstractHelpBlock" data-bs-toggle="collapse"
              ><i
                onclick="toggleArrow(this)"
                class="fa fa-caret-down fa-2x fa-fw"
              ></i
            ><span class="sr-only">Abstract helper text toggle</span></a></a>
          </div>
          <div class="col-11">
            <div
              id="abstractHelpBlock"
              class="collapse show form-text pb-2 text-dark"
            >
              A brief description of the resource and the context in which the
              resource was created.
            </div>
          </div>
        </div>

        <div class="pb-1">
          <label for="publisher" class="form-label fs-6 mt-3 required"
            >Publisher</label
          >
        </div>
        <div class="pb-1">{{ form.publisher }}</div>
        <div class="row">
          <div class="col-1">
            <a href="#publisherHelpBlock" data-bs-toggle="collapse"
              ><i
                onclick="toggleArrow(this)"
                class="fa fa-caret-down fa-2x fa-fw"
              ></i
            ><span class="sr-only">Publisher helper text toggle</span></a></a>
          </div>
          <div class="col-11">
            <div id="publisherHelpBlock" class="collapse show form-text pb-2 text-dark">
              The name of the entity that holds, archives, publishes prints,
              distributes, releases, issues, or produces the resource. This
              property will be used to formulate the citation, so consider the
              prominence of the role. For software, use Publisher for the code
              repository. If there is an entity other than a code repository, that
              "holds, archives, publishes, prints, distributes, releases, issues,
              or produces" the code, use the property Contributor/contributorType/
              hostingInstitution for the code repository.Examples: World Data
              Center for Climate (WDCC); GeoForschungsZentrum Potsdam (GFZ);
              Geological Institute, University of Tokyo, GitHub
            </div>
          </div>
        </div>
        
        <div class="pb-1">
          <label for="publicationYear" class="form-label fs-6 mt-3 required"
            >Publication Year</label
          >
        </div>
        <div class="col-4 pb-1">{{ form.publication_year }}</div>
        <div class="row">
          <div class="col-1">
            <a href="#publicationYearHelpBlock" data-bs-toggle="collapse"
              ><i
                onclick="toggleArrow(this)"
                class="fa fa-caret-down fa-2x fa-fw"
              ></i
            ><span class="sr-only">Publication year helper text toggle</span></a></a>
          </div>
          <div class="col-11">
            <div id="publicationYearHelpBlock" class="collapse show form-text pb-2 text-dark">
              The year when the data was or will be made publicly available. In
              the case of resources such as software or dynamic data where there
              may be multiple releases in one year, include the Date/dateType/
              dateInformation property and sub-properties to provide more
              information about the publication or release date details.YYYY ***
              If an embargo period has been in effect, use the date when the
              embargo period ends. In the case of datasets, "publish" is
              understood to mean making the data available on a specific date to
              the community of researchers. If there is no standard publication
              year value, use the date that would be preferred from a citation
              perspective.
            </div>
          </div>
        </div>
        <div class="pb-1">
          <label for="resourceType" class="form-label fs-6 mt-3 required"
            >Resource Type</label
          >
        </div>
        <div class="row">
          <div class="col pb-1">{{ form.resource_type }}</div>
          <div class="col pb-1">{{ form.resource_type_text }}</div>
        </div>
        <div class="row">
          <div class="col-1">
            <a href="#resourceTypeHelpBlock" data-bs-toggle="collapse"
              ><i
                onclick="toggleArrow(this)"
                class="fa fa-caret-down fa-2x fa-fw"
              ></i
            ><span class="sr-only">Resource type helper text toggle</span></a></a>
          </div>
          <div class="col-11">
        <div id="resourceTypeHelpBlock" class="collapse show form-text pb-2 text-dark">
          The resource that is being identified can be of any kind, but it is
          typically a dataset.
        </div>
          </div>
        </div>


        {{ funderformset.management_form }}
        <div class="pb-1">
          <label for="funder" class="form-label fs-6 mt-3">Funder</label>
        </div>
        {% for form in funderformset %}
        <div class="row form-row spacer funderformset-row">
          <div class="row mb-2">
            <div class="col">{{form.funder_name}}</div>
            <div class="col">{{form.funder_identifier}}</div>
            <div class="col">{{form.award_number}}</div>
            <div class="col">{{form.award_title}}</div>
            <div class="col-1">
              <button type="button" class="btn btn-danger remove-form-row btn-sm">
                üóô
              </button>
            </div>
          </div>
        </div>
        {% endfor %}
        <button
          type="button"
          id="funderformset-add"
          class="btn btn-success btn-sm add-form-row"
        >
          Add funder
        </button>
        <div class="row">
          <div class="col-1">
            <a href="#funderHelpBlock" data-bs-toggle="collapse"
              ><i
                onclick="toggleArrow(this)"
                class="fa fa-caret-down fa-2x fa-fw"
              ></i
            ><span class="sr-only">Funder helper text toggle</span></a></a>
          </div>
          <div class="col-11">
            <div
              id="funderHelpBlock"
              class="collapse show form-text pb-2 text-dark"
            >
            Uniquely identifies a funding
            entity, according to various
            types.
            </div>
          </div>
        </div>


        {{ subjectformset.management_form }}
        <div>
          <div class="mt-3">
            <label for="subject" class="form-label fs-6">Subject</label>
          </div>
          {% for form in subjectformset %}
          <div class="row form-row subjectformset-row mb-2">
            <div class="col-6">{{form.subject}}</div>
            <div class="col">
              <button type="button" class="btn btn-danger remove-form-row btn-sm">
                üóô
              </button>
            </div>
          </div>
          {% endfor %}
          <button
            type="button"
            id="subjectformset-add"
            class="btn btn-success add-form-row btn-sm"
          >
            Add subject
          </button>
          <div class="row">
            <div class="col-1">
              <a href="#subjectHelpBlock" data-bs-toggle="collapse"
                ><i
                  onclick="toggleArrow(this)"
                  class="fa fa-caret-down fa-2x fa-fw"
                ></i
              ><span class="sr-only">Subject helper text toggle</span></a></a>
            </div>
            <div class="col-11">
            <div id="subjectHelpBlock" class="collapse show form-text pb-2 text-dark">
              Subject, keyword, classification code, or key phrase describing the
              resource.
            </div>
        </div>
          </div>
        
          {{ relatedidentifierformset.management_form }}
        <div>
          <div class="mt-3">
            <label for="relatedIdentifier" class="form-label fs-6">Related Identifier</label>
          </div>
          {% for form in relatedidentifierformset %}
          <div class="row form-row relatedidentifierformset-row mb-2">
            <div class="col-3">{{form.related_identifier}}</div>
            <div class="col-3">{{form.related_identifier_type}}</div>
            <div class="col-3">{{form.related_identifier_relation_type}}</div>
            <div class="col">
              <button type="button" class="btn btn-danger remove-form-row btn-sm">
                üóô
              </button>
            </div>
          </div>
          {% endfor %}
          <button
            type="button"
            id="relatedidentifierformset-add"
            class="btn btn-success add-form-row btn-sm"
          >
            Add related identifier
          </button>
          <div class="row">
            <div class="col-1">
              <a href="#relatedIdentifierHelpBlock" data-bs-toggle="collapse"
                ><i
                  onclick="toggleArrow(this)"
                  class="fa fa-caret-down fa-2x fa-fw"
                ></i
              ><span class="sr-only">Related identifier helper text toggle</span></a></a>
            </div>
            <div class="col-11">
            <div id="relatedIdentifierHelpBlock" class="collapse show form-text pb-2 text-dark">
              Identifiers of related resources.
              These must be globally unique
              identifiers.
            </div>
            </div>
          </div>

        <div class="pb-1">
          <label for="version" class="form-label fs-6 mt-3">Version</label>
        </div>
        <div class="pb-1 col-6">{{ form.version }}</div>
        <div class="row">
          <div class="col-1">
            <a href="#versionHelpBlock" data-bs-toggle="collapse"
              ><i
                onclick="toggleArrow(this)"
                class="fa fa-caret-down fa-2x fa-fw"
              ></i
            ><span class="sr-only">Version helper text toggle</span></a></a>
          </div>
          <div class="col-11">
            <div id="versionHelpBlock" class="collapse show form-text pb-2 text-dark">
              The version number of the resource.
            </div>
          </div>
        </div>
      
        {{ dateformset.management_form }}
        <div class="pb-1">
          <label for="date" class="form-label fs-6 mt-3">Date</label>
        </div>
        {% for form in dateformset %}
        <div class="row form-row spacer dateformset-row">
          <div class="row mb-2">
            <div class="col">{{form.date}}</div>
            <div class="col">{{form.date_type}}</div>
            <div class="col">{{form.date_text}}</div>
            <div class="col-1">
              <button type="button" class="btn btn-danger remove-form-row btn-sm">
                üóô
              </button>
            </div>
          </div>
        </div>
        {% endfor %}
        <button
          type="button"
          id="dateformset-add"
          class="btn btn-success btn-sm add-form-row"
        >
          Add date
        </button>



        <div class="row">
          <div class="col-1">
            <a href="#dateHelpBlock" data-bs-toggle="collapse"
              ><i
                onclick="toggleArrow(this)"
                class="fa fa-caret-down fa-2x fa-fw"
              ></i
            ><span class="sr-only">Date helper text toggle</span></a></a>
          </div>
          <div class="col-11">
            <div id="dateHelpBlock" class="collapse show form-text pb-2 text-dark">
              Use the following formats YYYY, YYYY-MM, YYYY-MM-DD
              Years before 0000 must be
              prefixed with a -sign,
              e.g., -0054 to indicate 55 BC.
            </div>
          </div>
        </div>

        <div class="row offset-5 spacer">
          <div class="col-4 mt-4 d-grid gap-2">
            <button type="submit" class="btn btn-block btn-primary">
              Create
            </button>
          </div>
          <div>{{err}}</div>
        </div>
      </form>
    </div>
  </div>
</div>
<script type="text/javascript">
  $(document).ready(function() {
    window.fundersRemote = new Bloodhound({
      name: 'funders',
      datumTokenizer: function(d) { return d.tokens; },
      queryTokenizer: Bloodhound.tokenizers.whitespace,
      remote: {
        url: 'https://api.crossref.org/funders?query=%QUERY',
        filter: function(dataResponse) { return dataResponse.message.items; }
      },
      limit: 16,
      dupDetector: function(r, l) { return false; }
    });
  
    fundersRemote.initialize();
  
    var suggestionLayout = Hogan.compile('<p>{{name}} <small>{{location}}</small></p>');
  
    $('.search-input').typeahead(null, {
      name: 'funders',
      source: fundersRemote.ttAdapter(),
      templates: {
        suggestion: function (data) {
          return '<p><strong>' + data.name + '</strong> - ' + data.location + '</p>';
        }
        },
      limit: 16
    });
  
    $('.search-input').bind('typeahead:autocompleted typeahead:selected', function(e, datum) {
      $(this).typeahead('val', datum.name);
      $(this).closest('.funderformset-row').find('.funder_id').val(datum.id);
    });
  });

  function updateElementIndex(el, prefix, ndx) {
    var id_regex = new RegExp("(" + prefix + "-\\d+)");
    var replacement = prefix + "-" + ndx;
    if ($(el).attr("for"))
      $(el).attr("for", $(el).attr("for").replace(id_regex, replacement));
    if (el.id) el.id = el.id.replace(id_regex, replacement);
    if (el.name) el.name = el.name.replace(id_regex, replacement);
  }
  function cloneMore(selector, prefix) {
    var newElement = $(selector).clone(true);
    var total = $("#id_" + prefix + "-TOTAL_FORMS").val();
    newElement
      // .find(":input:not([type=button]):not([type=submit]):not([type=reset])")
      .find(":input[name]")
      .each(function () {
        console.log($(this));
        var name = $(this)
          .attr("name")
          .replace("-" + (total - 1) + "-", "-" + total + "-");
        var id = "id_" + name;
        $(this).attr({ name: name, id: id }).val("").removeAttr("checked");
      });
    newElement.find("label").each(function () {
      var forValue = $(this).attr("for");
      if (forValue) {
        forValue = forValue.replace("-" + (total - 1) + "-", "-" + total + "-");
        $(this).attr({ for: forValue });
      }
    });
    total++;
    $("#id_" + prefix + "-TOTAL_FORMS").val(total);
    $(newElement).find(".btn.remove-form-row").prop("hidden", false);
    $(selector).after(newElement);
    return false;
  }
  function deleteForm(prefix, btn) {
    var total = parseInt($("#id_" + prefix + "-TOTAL_FORMS").val());
    if (total > 1) {
      btn.closest(".form-row").remove();
      var forms = $(".form-row");
      $("#id_" + prefix + "-TOTAL_FORMS").val(forms.length);
      for (var i = 0, formCount = forms.length; i < formCount; i++) {
        $(forms.get(i))
          .find(":input")
          .each(function () {
            updateElementIndex(this, prefix, i);
          });
      }
    }
    return false;
  }

  $(document).on("click", "#subjectformset-add", function (e) {
    e.preventDefault();
    cloneMore(".subjectformset-row:last", "subjectform");
    return false;
  });
  $(document).on("click", ".subjectformset-row .remove-form-row", function (e) {
    e.preventDefault();
    deleteForm("subjectform", $(this));
    return false;
  });
 
  $(document).on("click", "#relatedidentifierformset-add", function (e) {
    e.preventDefault();
    cloneMore(".relatedidentifierformset-row:last", "relatedidentifierform");
    return false;
  });
  $(document).on("click", ".relatedidentifierformset-row .remove-form-row", function (e) {
    e.preventDefault();
    deleteForm("relatedidentifierform", $(this));
    return false;
  });

  $(document).on("click", "#creatorformset-add", function (e) {
    e.preventDefault();
    cloneMore(".creatorformset-row:last", "creatorform");
    return false;
  });
  $(document).on("click", ".creatorformset-row .remove-form-row", function (e) {
    e.preventDefault();
    deleteForm("creatorform", $(this));
    return false;
  });
 
  $(document).on("click", "#dateformset-add", function (e) {
    e.preventDefault();
    cloneMore(".dateformset-row:last", "dateform");
    return false;
  });
  $(document).on("click", ".dateformset-row .remove-form-row", function (e) {
    e.preventDefault();
    deleteForm("dateform", $(this));
    return false;
  });
 
  $(document).on("click", "#funderformset-add", function (e) {
    e.preventDefault();
    $('.search-input').typeahead("destroy");
    cloneMore(".funderformset-row:last", "funderform");
    $(".search-input").typeahead(null, {
      name: 'funders',
      source: fundersRemote.ttAdapter(),
      templates: {
        suggestion: function (data) {
          return '<p><strong>' + data.name + '</strong> - ' + data.location + '</p>';
        }
        },
      limit: 16
    });
    $('.funderformset-row:last').find(".search-input").bind('typeahead:autocompleted typeahead:selected', function(e, datum) {
      $(this).typeahead('val', datum.name);
      $(this).closest('.funderformset-row').find('.funder_id').val(datum.id);
    });
    return false;
  });
  $(document).on("click", ".funderformset-row .remove-form-row", function (e) {
    e.preventDefault();
    deleteForm("funderform", $(this));
    return false;
  });

  $(".subjectformset-row:first .remove-form-row").prop("hidden", true);
  $(".relatedidentifierformset-row:first .remove-form-row").prop("hidden", true);
  $(".creatorformset-row:first .remove-form-row").prop("hidden", true);
  $(".dateformset-row:first .remove-form-row").prop("hidden", true);
  $(".funderformset-row:first .remove-form-row").prop("hidden", true);

  function toggleArrow(arrow) {
    arrow.classList.toggle("fa-caret-up");
  }
</script>

<style>
  label.required::after {
    content: "*";
    color: red;
  }
</style>
{% endblock %}
